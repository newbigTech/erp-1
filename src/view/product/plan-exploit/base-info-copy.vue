<template>
    <div class="c-base-info-copy">
        <el-form :model="formData" label-width="180px">
            <el-form-item label="分类：" required>
                <el-cascader
                        v-model="formData.category_id"
                        placeholder="输入搜索"
                        :options="muiSelects"
                        filterable></el-cascader>
            </el-form-item>
            <el-form-item label="开发平台：" required>
                <el-select v-model="formData.dev_platform"
                           class="inline s-width-large"
                           default-first-option
                           filterable clearable>
                    <el-option
                        v-for="res in platformList"
                        :label="res.label"
                        :value="res.value"
                        :key="res.value"
                    ></el-option>   
                </el-select>   
            </el-form-item>
            <el-form-item label="平台分类：">
                <el-row v-for="(item,index) in formData.platform" :key="index">
                    <span>{{item.label}}</span>
                    <el-button type="primary" size="mini" class="inline" @click.native="edit_platform(item,index)">编辑</el-button>
                    <el-button type="danger" size="mini" class="inline" @click.native="delete_platform(index)">删除</el-button>
                </el-row>
                <el-button type="primary" size="mini" class="inline" @click.native="add_platform">添加平台分类</el-button>
            </el-form-item>
            <el-form-item label="产品标题：" required>
                <el-input v-model="formData.title" class="base-info-width"></el-input>
            </el-form-item>
            <el-form-item label="产品图片：" required>
                <add-local-image v-model="formData.thumb"></add-local-image>
            </el-form-item>
            <el-form-item label="品牌：" required>
                <param-account v-model="formData.brand_id"
                               :fix-result="fix_result"
                               url="get|brand/dictionary"
                               type="productBrand"></param-account>
                <el-button type="primary"
                           size="mini"
                           @click.native="add_brand"
                           class="inline">新增品牌</el-button>
                <el-button type="text"
                           size="mini"
                           class="inline">上传授权书</el-button>
            </el-form-item>
            <el-form-item label="产品侵权风险：">
                <el-select v-model="formData.tort_id"
                           class="inline s-width-large"
                           default-first-option
                           filterable clearable>
                    <el-option
                            v-for="res in tortList"
                            :label="res.name"
                            :value="res.id"
                            :key="res.id"
                    ></el-option>
                </el-select>
            </el-form-item>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="采购价（CNY）：" required>
                        <el-input v-model="formData.purchase_price"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="最低限价（CNY）：">
                        <el-input v-model="formData.lowest_sale_price"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <el-form-item label="建议售价（USD）：" required>
                        <el-input v-model="formData.advice_price"></el-input>
                    </el-form-item>
                </el-col>
                <el-col :span="8">
                    <el-form-item label="竞争对手售价（USD）：">
                        <el-input v-model="formData.competitor_price"></el-input>
                    </el-form-item>
                </el-col>
            </el-row>
            <el-form-item label="本平台预估毛利率：">
                <el-input v-model="formData.gross_profit" class='s-width-large inline'></el-input> %
            </el-form-item>
            <el-form-item label="产品毛重：" required>
                <el-input v-model="formData.weight" class='s-width-large inline'></el-input> g
            </el-form-item>
            <el-form-item label="平台连接：">
                <div class="base-info-width">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.source_url"></el-input>
                    <el-button type="primary" size="mini"
                               @click.native="open_url">打开平台链接</el-button>
                </div>
            </el-form-item>
            <el-form-item label="采购链接：">
                <div v-for="(row,index) in formData.purchase_url"
                     class="base-info-width mb-mini">
                    <el-input style="width:80%;display: inline-block"
                              v-model="formData.purchase_url[index]"></el-input>
                        <el-button size="mini" type="success"
                                   :disabled="!formData.purchase_url[index]"
                                   @click="open_link(index)">打开链接</el-button>
                        <el-button size="mini" type="danger"
                                   v-show="formData.purchase_url.length>1&&index!==formData.purchase_url.length-1"
                                   @click="del_link(index)">删除</el-button>
                        <el-button type="primary" size="mini"
                                   v-show="index===formData.purchase_url.length-1"
                                   @click.native="add_url">添加</el-button>
                </div>
            </el-form-item>
            <el-form-item label="销售平台状态：">
                <platform-sale :platform-data="formData.platform_sale"
                               :plat="formData.plat" :editAble="editAble"></platform-sale>
            </el-form-item>
            <el-form-item label="产品描述：">
                <el-input type="textarea"
                          v-model="formData.description"
                          class="base-info-width"></el-input>
            </el-form-item>
        </el-form>
        <add-classify v-model="addClassify"
                      @getclass="mdf_classify"
                      ref="classify"></add-classify>
        <add-brand v-model="brandDialog"
                   :is-edit="true"
                   @reload="reload_brand"
                   :brand-form="brandForm"></add-brand>
    </div>
</template>
<style lang="stylus">
    .base-info-width{
        width:75%;
        display: inline-block;
    }
</style>
<script>
    import {api_get_categories} from   '../../../api/categories';
    import {api_get_channel} from '@/api/order-local';
    import {publish_edit_tort}from '@/api/product-library';
    export default{
        data(){
            return{
                editAble:true,
                muiSelects:[],
                platformList:[],
                brandList:[],
                tortList:[],
                addClassify:false,
                isAddPlatform:false,
                brandDialog:false,
                classify_index:0,
                /*品牌*/
                brandForm:{
                    name:'',
                    code:'',
                    logo:'',
                    site_url:'',
                    description:''
                },
            }
        },
        mounted(){
            this.init_categories();
            this.get_channel();
            this.get_tort();
            console.log(this.formData,'this.formData');
        },
        methods:{
            add_brand(){
                this.brandDialog = true;
            },
            reload_brand(id,form){
                /*当前品牌组件有问题，待调整*/
                console.log(id,form,'id,form');
            },
            mdf_classify(mdf){
                let length=mdf.length;
                let label = mdf.map(lable=>lable.label);
                let data = {
                    label: label.join(">>"),
                    path: JSON.stringify(mdf),
                    channel_id: mdf[0].id,
                    channel_category_id: mdf[length-1].id
                };
                if(mdf[1].code){
                    data.site_id=mdf[1].id;
                }else {
                    data.site_id=0;
                }
                if (this.isAddPlatform) {
                    this.formData.platform.push(data);
                }else {
                    this.formData.platform.splice(this.classify_index,1,data);
                }
            },
            /*平台分类*/
            add_platform(){//添加
                this.isAddPlatform=true;
                this.addClassify = true;
                this.$refs.classify.isAdd=true;
                this.$refs.classify.plat = [];
                this.$nextTick(() => {
                    this.$refs.classify.req = []
                });
            },
            edit_platform(item,index){//编辑
                this.isAddPlatform=false;
                this.classify_index=index;
                this.$refs.classify.index=index;
                this.$refs.classify.plat=this.formData.platform;
                this.$refs.classify.isAdd=false;
                if (item.path && item.path !== "") {
                    this.$refs.classify.req = JSON.parse(item.path);
                } else {
                    this.$refs.classify.req = [];
                }
                this.addClassify = true;
                this.$nextTick(()=>{
                    this.$refs.classify.$refs.addclass.edit()
                })
            },
            delete_platform(index){ //删除
                this.formData.platform.splice(index,1);
            },

            /*采购链接*/
            open_link(index){
                let url = this.formData.purchase_url[index];
                console.log(url,'url');
            },
            open_url(){
                console.log('打开链接',this.formData.source_url);
            },
            del_link(index){
                this.formData.purchase_url.splice(index,1);
            },
            add_url(){
                this.formData.purchase_url.push('');
            },
            fix_result(val){
                return val.map(row=>{
                    return {
                        label:row.name,
                        value:row.id
                    }
                })
            },
            /*API 请求区
            * */
            init_categories(){
                let get_child_ids=(child_ids,data)=>{
                    let childList = child_ids.map(row=>{
                        return data[row]
                    });
                    childList = childList.map(row=>{
                        let dataobj = {
                            value:row.id,
                            label:row.title?row.title:row.name,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataobj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataobj
                    });
                    return childList;
                };
                this.$http(api_get_categories).then(data=>{
                    let plist = Object.values(data).filter(row=>row.pid===0);
                    plist = plist.map(row=>{
                        let dataObj = {
                            label:row.title?row.title:row.name,
                            value:row.id,
                        };
                        if(row.child_ids&&row.child_ids.length>0){
                            this.$set(dataObj,'children',get_child_ids(row.child_ids,data));
                        }
                        return dataObj
                    });
                    this.muiSelects = plist;
                }).catch(code=>{
                    this.$message({
                        type:"error",
                        message:code.message || code
                    })
                });
            },
            get_channel(){
                this.$http(api_get_channel).then(res => {
                    this.platformList = res;
                }).catch(code => {
                    this.$message({type:'error',message:code.message||code});
                })
            },

            get_tort(){
                this.$http(publish_edit_tort).then(res => {
                    this.tortList = res;
                }).catch(code => {
                    console.log(code,'code');
                });
            }
        },
        props:{
            formData:{
                type:Object,
                required:true
            },
        },
        components:{
            paramAccount:require('@/api-components/param-account.vue').default,
            addLocalImage:require('./add-local-image.vue').default,
            addClassify: require("../classify/add-classify.vue").default,
            addBrand:require('../brand/add-brand').default,
            platformSale:require('../platform-sale').default,
        }
    }
</script>
