<template>
    <page class="p-plan-exploit">
        <search-data :search-data="searchData"
                     @click-button="click_button"
                     :clears="clears"
                     @search="init"></search-data>
        <div class="mt-xs mb-xs ml-sm">
            <el-button type="primary" size="mini" @click="create">创建</el-button>
            <el-button type="primary" size="mini" disabled>批量导出</el-button>
        </div>
        <table-data :table-data="tableData"
                    @read-goods="read_goods"
                    @edit="edit"
                    @dispose-goods="dispose_goods"
                    @size-change="size_change"
                    @current-change="current_change"
                    :loading="loading"></table-data>
        <!--<new-product v-model="newProductVisible"-->
                     <!--@select-product="select_product"></new-product>-->
        <create-sku-product v-model="createSkuVisible"
                            :selectProduct="selectProduct"
                            :isEdit="isEdit" :id="id"
                            :isComplete="isComplete"
                            :isDispose="isDispose"
                            :disposeBtn="disposeBtn"
                            :isCreate="isCreate"
                            :fromData="fromData"
                            :status="status"
                            @update-product="update_product"
                            @edit-product="edit_product">
        </create-sku-product>
        <create-success v-model="createProductVisible" :isEdit="isEdit" :fromData="fromData"
                        :isDispose="isDispose" :id="id" :isComplete="isComplete"
                        :disposeBtn="disposeBtn" :isDisposeEdit="isDisposeEdit" :status="status"
                        :selectProduct="selectProduct" @edit-product="edit_product"
                        @add-good="update_product" @dispose-goods="init">
        </create-success>
    </page>
</template>

<style lang="stylus">

</style>
<script>
    import {
        api_get_goods,
        api_goods_log,
        api_goods_process,
        api_read_good,
        api_proposer,
        api_product_person,
        api_get_goods_pre_dev_audit
    } from '../../../api/plan-exploit'
    export default{
        page: {},
        refresh(){
            this.init();
        },
        data(){
            return {
                publicForm: {},
                searchData: {
                    process_id: '',
                    create_id: '',
                    search_key: 'code',
                    search_val: '',
                    create_time_start: '',
                    create_time_end: ''
                },
                clears:{
                    process_id: '',
                    create_id: '',
                    search_key: 'code',
                    search_val: '',
                    create_time_start: '',
                    create_time_end: ''
                },
                id: '',
                isEdit: false,
                newIntroDialog: false,
                isComplete: false,
                isCreate: false,
                tableData:{
                    lists:[],
                    page:1,
                    pageSize:50,
                    count:0,
                },
                accountType: [
                    {label: "流程编号", value: 'code'},
                    {label: "产品名称", value: 'title'}
                ],
                count: 0,
                loading: false,
                selectProduct: {},
                onlyReadData: {},
                newProductVisible: false,
                createProductVisible: false,
                createSkuVisible: false,
                lookEditVisible: false,
                isDispose: false,
                isDisposeEdit: false,
                disposeBtn: [],
                status: '',
                fromData: {},

            }
        },
        mounted(){
            this.init();
        },
        methods: {
            click_button(){
                this.init();
            },
            init(){
                this.loading = true;
                let data = this.data_format();
                this.$set(data,'page',this.tableData.page);
                this.$set(data,'pageSize',this.tableData.pageSize);
                this.$http(api_get_goods, data).then(res => {
                    this.tableData.lists = res.data;
                    this.tableData.count = res.count;
                }).catch(code => {
                    this.$message({type:'error',message:code.message||code});
                }).finally(()=>{
                    this.loading = false;
                })
            },
            update_product(val, id){
                if (this.searchData.process_id === 0) {
                    let find = this.tableData.lists.find(res => {
                        return res.id === val.id;
                    });
                    if (val.remark) {
                        if (val.code === 'kf_audit_fail') {
                            if (!!find) {
                                find.process = `开发主管审核不通过`;
                            }
                        } else if (val.code === 'kf_audit_success') {
                            if (!!find) {
                                find.process = `待销售主管审核`;
                            }
                        } else if (val.code === 'cancel') {
                            if (!!find) {
                                find.process = `作废`;
                            }
                        } else if (val.code === 'xs_audit_fail') {
                            if (!!find) {
                                find.process = `销售主管审核不通过`;
                            }
                        } else if (val.code === 'xs_audit_success') {
                            if (!!find) {
                                find.process = `待sku查重`;
                            }
                        } else if (val.code === 'sku_audit_fail') {
                            if (!!find) {
                                find.process = `sku查重不通过`;
                            }
                        } else if (val.code === 'sku_audit_success') {
                            if (!!find) {
                                find.process = `sku查重通过`;
                                this.$set(find,'is_complete', 0);
                                this.$set(find, 'is_create_sku', 1);
                                this.$set(find, 'is_edit', 0);
                            }
                        } else if (val.code === 'sku_success') {
                            if (!!find) {
                                find.process = `sku已生成`;
                            }
                        }
                    } else if (val.id) {
                        if (!!find) {
                            Object.assign(find, val);
                        }
                    } else {
                        this.$set(val, 'id', id);
                        this.$set(val, 'is_edit', 1);
                        this.tableData.lists.unshift(val);
                        this.count += 1;
                    }
                } else {
                    let index = this.tableData.lists.findIndex(row => {
                        return row.id === val.id;
                    });
                    this.tableData.lists.splice(index, 1);
                    this.count -= 1;
                }
            },
            //日期整理
            data_format(){
                if (!!this.searchData.create_time_start) {
                    let b = new Date(this.searchData.create_time_start);
                    this.searchData.create_time_start = datef("YYYY-MM-dd", b / 1000);
                } else {
                    this.searchData.create_time_start = "";
                }
                if (!!this.searchData.create_time_end) {
                    let e = new Date(this.searchData.create_time_end);
                    this.searchData.create_time_end = datef("YYYY-MM-dd", e / 1000);
                } else {
                    this.searchData.create_time_end = "";
                }
                return this.searchData;
            },

            create(){
                this.fromData = {
                    category_id: '',
                    dev_platform: '',
                    brand_id: '',
                    title: '',
                    tort_id: '',
                    purchase_price: '',
                    advice_price: '',
                    lowest_sale_price: '',
                    competitor_price: '',
                    gross_profit: '',
                    weight: '',
                    net_weight: '',
                    height: '',
                    length: '',
                    width: '',
                    volume_weight: '',
                    is_packing: '',
                    packing_id: '',
                    unit_id: '',
                    source_url: '',
                    thumb: [],
                    images: [],
                    tags: [],
                    description: '',
                    platform_sale: [
                        {
                            id: 1,
                            name: "ebay",
                            title: "eBay平台",
                            value_id: 1,
                            value: ''
                        },
                        {
                            id: 2,
                            name: "amazon",
                            title: "亚马逊平台",
                            value_id: 1,
                            value: ''
                        },
                        {
                            id: 3,
                            name: "wish",
                            title: "Wish平台",
                            value_id: 1,
                            value: ''
                        },
                        {
                            id: 4,
                            name: "aliExpress",
                            title: "速卖通平台",
                            value_id: 1,
                            value: ''
                        }
                    ],
                    propertie: [],
                    properties: [],
                    developer_note: '',
                    purchase_url: [],
                    audit: 0
                };
                this.isEdit = true;
                this.isDispose = false;
                this.isComplete = false;
                this.isDisposeEdit = false;
//                this.newProductVisible = true;
                this.createSkuVisible = true;
                this.isCreate = true;
                this.status = '创建';
            },
            edit(row){
                this.selectProduct = {title: row.category, value: row.category_id};
                this.isEdit = true;
                this.isComplete = false;
                this.isDispose = false;
                this.isDisposeEdit = false;
                this.createSkuVisible = true;
                this.isCreate = false;
                this.status = `编辑产品：${row.title}信息`;
                this.get_goods_data(row);
            },
            read_goods(row){//查看
                this.selectProduct = {title: row.category, value: row.category_id};
                this.id = row.id;
                this.isCreate = false;
                this.isDispose = false;
                this.isEdit = false;
                this.isDisposeEdit = false;
                this.status = `查看产品：${row.title}信息`;
                if (row.is_complete === 1) {//完结
                    this.isComplete = true;
                    this.createSkuVisible = true;
                    this.get_goods_data(row);
                } else {
                    this.isComplete = false;
                    this.createSkuVisible = true;
                    this.get_goods_data(row);
                }
            },

            dispose_goods(row){//处理
                this.selectProduct = {title: row.category, value: row.category_id};
                this.id = row.id;
                this.isCreate = false;
                this.isDisabled = true;
                this.isEdit = false;
                this.isDispose = true;
                this.status = `处理产品：${row.title}信息`;
                this.get_audit(row.id);
                if (row.is_create_sku === 1) {//通过审核处理
                    this.isComplete = true;
                    this.isDisposeEdit = true;
                    this.createProductVisible = true;
                    this.get_goods_data(row);
                } else {
                    this.isComplete = false;
                    this.isDisposeEdit = false;
                    this.createSkuVisible = true;
                    this.get_goods_data(row);
                }
            },
            get_goods_data(row){
                this.fromData.images = [];
                this.$http(api_read_good, row.id).then(res => {
                    res.gross_profit = String(res.gross_profit);
                    res.net_weight = String(res.net_weight);
                    res.weight = String(res.weight);
                    if(res.warehouse_id === 0){
                        res.warehouse_id = ''
                    }
                    this.fromData = res;
                    if (this.isDisposeEdit) {
                        this.$set(this.fromData, 'packing_id', '');
                        this.$set(this.fromData, 'packing_back_id', '');
                        this.$set(this.fromData, 'is_photo', '');
                        this.$set(this.fromData, 'photo_remark', '');
                        this.$set(this.fromData, 'undisposed_img_url', '');
                        this.$set(this.fromData, 'is_impower', '');
                        this.$set(this.fromData, 'is_sampling', '');
                        this.$set(this.fromData, 'is_multi_warehouse', '');

                    }
                    console.log(this.fromData);
                })
            },
            get_audit(id){
                this.$http(api_get_goods_pre_dev_audit, {id: id}).then(res => {
                    this.disposeBtn = res;
                })
            },
            //分页器事件
            size_change(val){
                this.tableData.pageSize = val;
                this.init();
            },
            current_change(val){
                this.tableData.page = val;
                this.init();
            },
            select_product(val){
                this.selectProduct = val;
                this.createSkuVisible = true;
            },
            edit_product(){
//                this.newProductVisible = true;
            }
        },
        components: {
            labelItem: require('../../../components/label-item.vue').default,
            labelButtons: require('../../../components/label-buttons.vue').default,
            newProduct: require('./new-product.vue').default,
            editProduct: require("./edit-product.vue").default,
            createSkuProduct: require("./create-sku-product.vue").default,
            createSuccess: require("./create-success.vue").default,
            searchCard:require('../../../components/search-card.vue').default,
            tableData:require('./table-data.vue').default,
            searchData:require('./search-data.vue').default,
        }
    }
</script>

